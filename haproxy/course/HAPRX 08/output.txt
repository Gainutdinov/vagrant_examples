–ó–∞–¥–∞–Ω–∏–µ:
–ü—Ä–∞–≤–∏–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

enable keepalived

–í –¥–∞–Ω–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏ –≤–∞–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ 2 –º–∞—à–∏–Ω–∞–º, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω haproxy –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤–µ–± —Å–µ—Ä–≤–µ—Ä. –í –¥–∞–Ω–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–ª–∞—Å—Ç–µ—Ä –∏–∑ 2 –º–∞—à–∏–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º haproxy –∏ keepalived. –ú–∞—à–∏–Ω—É master –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ MASTER —Å–µ—Ä–≤–µ—Ä–∞. –ú–∞—à–∏–Ω—É —Å –∏–º–µ–Ω–µ–º BACKUP –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ backup —Å–µ—Ä–≤–µ—Ä–∞

–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ haproxy –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –ø—É—Ç–∏ /etc/haproxy/haproxy.cfg.

–í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å haproxy –Ω–∞ –¥–≤—É—Ö –º–∞—à–∏–Ω–∞—Ö —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

    –°–æ–∑–¥–∞—Ç—å —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–Ω–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç rebrain.pem, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á, –∏ —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å –µ–≥–æ –ø–æ –ø—É—Ç–∏ /etc/haproxy/rebrain.pem
    –ö–æ–Ω—Ñ–∏–≥ haproxy –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 1 —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å –∏–º–µ–Ω–µ–º front_cluster, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–π —Å–ª–µ–¥—É—é—â–∏–º —É—Å–ª–æ–≤–∏—è–º:

    –ü—Ä–æ—Å–ª—É—à–∏–≤–∞—Ç—å –ø–æ—Ä—Ç 443 —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É –∏–∑ –ø—É–Ω–∫—Ç–∞ 1
    –†–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–µ–∂–∏–º–µ http
    –î–æ–±–∞–≤–ª—è—Ç—å ip –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ –∫–æ –≤—Å–µ–º –≤—Ö–æ–¥—è—â–∏–º –ø–∞–∫–µ—Ç–∞–º –≤ header X-Forwarded-For
    –ë—ç–∫–µ–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é back_cluster

    –ö–æ–Ω—Ñ–∏–≥ haproxy –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 1 –±—ç–∫–µ–Ω–¥ —Å –∏–º–µ–Ω–µ–º back_cluster, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—â–∏–π —Å–ª–µ–¥—É—é—â–∏–º —É—Å–ª–æ–≤–∏—è–º:

    –†–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–µ–∂–∏–º–µ http
    –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ roundrobin
    –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ 3 —Å–µ—Ä–≤–µ—Ä–∞ —Å –∏–º–µ–Ω–∞–º–∏ rebrain_01, rebrain_02 –∏ rebrain_03 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –ø–æ –∞–¥—Ä–µ—Å—É 127.0.0.1:81. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ 20000

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å keepalived –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤ –ª–µ–∫—Ü–∏–∏. –í –∫–∞—á–µ—Å—Ç–≤–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ ip –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –∞–¥—Ä–µ—Å master —Å–µ—Ä–≤–µ—Ä–∞. –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –Ω–∞ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö –ø—Ä–æ—Ü–µ—Å—Å haproxy –∏ –≤ —Å–ª—É—á–∞–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –µ–≥–æ –Ω–∞ –º–∞—Å—Ç–µ—Ä —Å–µ—Ä–≤–µ—Ä–µ, –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π ip –¥–æ–ª–∂–µ–Ω –Ω–∞–∑–Ω–∞—á–∏—Ç—å—Å—è –Ω–∞ backup —Å–µ—Ä–≤–µ—Ä–µ, –∞ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏, –Ω–∞–∑–Ω–∞—á–∏—Ç—å—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ master —Å–µ—Ä–≤–µ—Ä–µ. –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π ip –∞–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:

inet 51.250.86.11/24 brd 51.250.86.255 scope global eth0:10

–ü—Ä–∏–º–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ ip 51.250.86.11

$ ip a
...
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether d0:0d:82:ee:06:08 brd ff:ff:ff:ff:ff:ff
    inet 10.128.0.15/24 brd 10.128.0.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet 51.250.86.11/24 brd 51.250.86.255 scope global eth0:10
...

–î–ª—è —Ä–∞–±–æ—Ç—ã keepalived –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã

cat << EOF >> /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv4.ip_nonlocal_bind = 1
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 1
net.ipv4.conf.all.arp_filter = 0
net.ipv4.conf.eth0.arp_filter = 1 
EOF
sysctl -p

–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –∫–∞–∫ —Å–µ—Ä–≤–∏—Å

systemctl keepalived enable

–ü–æ—á–µ–º—É —Ç–∞–∫?

–ù–∞—à–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Å–æ–∑–¥–∞–Ω—ã –≤ —è–Ω–¥–µ–∫—Å –æ–±–ª–∞–∫–µ. –ò —Å—Ç—Ä–æ–≥–æ –≥–æ–≤–æ—Ä—è, —Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥–ª—è keepalived –∑–¥–µ—Å—å –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç. –¢–æ –µ—Å—Ç—å keepalived –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å ip –∞–¥—Ä–µ—Å —Å –º–∞—à–∏–Ω—ã –Ω–∞ –º–∞—à–∏–Ω—É, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ haproxy. –ù–æ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ ip –Ω–µ —Å–º–µ–Ω–∏—Ç—Å—è –∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∏–¥—Ç–∏ –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–∞—Å—Ç–µ—Ä. –ü—Ä–∏ —ç—Ç–æ–º —Ç–∞ –∂–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏. –ü–æ—á–µ–º—É —Ç–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç? –í—Å–µ –∏–∑-–∑–∞ –æ–±–ª–∞–∫–æ–≤.

–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç keepalived.

–ù–∞ —Å–∞–º–æ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤ - –Ω–∞–ø—Ä–∏–º–µ—Ä VRRP –∏–ª–∏ CARP. Keepalived —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±–∞–∑–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ VRRP.

–û—Å–Ω–æ–≤–Ω–∞—è —Å—É—Ç—å —ç—Ç–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ IP –∞–¥—Ä–µ—Å–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π MAC –∞–¥—Ä–µ—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–µ–∑–∂–∞–µ—Ç —Å —É–∑–ª–∞ –Ω–∞ —É–∑–µ–ª –ø—Ä–∏ —Å–º–µ–Ω–µ –º–∞—Å—Ç–µ—Ä–∞. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –µ—Å–ª–∏ –Ω–∞—à –º–∞—Å—Ç–µ—Ä —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª, —Ç–æ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π (backup) —Å–µ—Ä–≤–µ—Ä —É–≤–∏–¥–µ–≤ —ç—Ç–æ –∑–∞–±–∏—Ä–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP –∏ MAC –∞–¥—Ä–µ—Å–∞ —Å–µ–±–µ –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ —ç—Ç–∏–º –∞–¥—Ä–µ—Å–∞–º. –°–≤–∏—Ç—á–∏, –∫ —Å–ª–æ–≤—É —Ç–∞–∫ –∂–µ –æ–±–Ω–æ–≤–ª—è—é—Ç —É —Å–µ–±—è —Ç–∞–±–ª–∏—Ü—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è MAC –∞–¥—Ä–µ—Å–∞ –∏ –ø–æ—Ä—Ç–∞ - —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π MAC –∞–¥—Ä–µ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –µ–≥–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ–± —ç—Ç–æ–º –ø—Ä–æ—Ç–æ–∫–æ–ª–µ –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤–æ—Ç –∑–¥–µ—Å—å - https://habr.com/ru/post/452490/.

–ü–æ—á–µ–º—É keepalived –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±–ª–∞–∫–µ?

–¢–µ–ø–µ—Ä—å, –∑–Ω–∞—è —á—Ç–æ keepalived –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫–∞–Ω–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ —Å–µ—Ç–µ–≤–æ–π –º–æ–¥–µ–ª–∏ OSI - —Ç–∞–º –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è MAC –∞–¥—Ä–µ—Å–∞, –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ—á–µ–º—É –æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±–ª–∞–∫–µ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ. –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–±–ª–∞–∫–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Software Defined Networks - SDN –∏ –æ–Ω–∏ –ø–ª–µ–≤–∞—Ç—å —Ö–æ—Ç–µ–ª–∏ –Ω–∞ –≤—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ç–µ–≤–æ–π –º–æ–¥–µ–ª–∏ OSI. –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –≤—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ç–µ–≤–æ–π –º–æ–¥–µ–ª–∏ —Ç–∞–º –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ù—É —Ç–æ—á–Ω–µ–µ –æ–Ω –∫–∞–∫ –±—ã –µ—Å—Ç—å, –Ω–æ —ç—Ç–æ –Ω–∏ –Ω–∞ —á—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç.

–í –æ–±—ã—á–Ω–æ–π —Å–µ—Ç–∏ –∫–æ–≥–¥–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä A —Ö–æ—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä—É B —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ —Å–µ—Ç–∏, –∫–æ–º–ø—å—é—Ç–µ—Ä A —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç IP –ø–∞–∫–µ—Ç –∏ Ethernet —Ñ—Ä–µ–π–º, –∫—É–¥–∞ –≤–ø–∏—Å—ã–≤–∞–µ—Ç –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è - MAC –∏ IP –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ B. –ò –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —Å–µ—Ç—å. –ò –≤–æ—Ç —Ç—É—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ. –í –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ —Å–≤–∏—Ç—á –ø–æ–ª—É—á–∏—Ç —Ñ—Ä–µ–π–º, –ø–æ—Å–º–æ—Ç—Ä–∏—Ç mac –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ–≥–æ –∫—É–¥–∞ –Ω—É–∂–Ω–æ.

–í –æ–±–ª–∞—á–Ω—ã—Ö –∂–µ —Å–µ—Ç—è—Ö –Ω–∞ –≤—ã—Ö–æ–¥–µ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ñ—Ä–µ–π–º –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –≥—É–≥–ª–æ–º, –≤—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å –Ω–∞—Ñ–∏–≥ –æ—Ç–±—Ä–æ—à–µ–Ω, –∞ –∑–∞ –æ—Å–Ω–æ–≤—É –±—É–¥–µ—Ç –≤–∑—è—Ç —Ç—Ä–µ—Ç–∏–π - —Å–µ—Ç–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ç–µ–≤–æ–π –º–æ–¥–µ–ª–∏ OSI. –ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–∞–∫–µ—Ç –±—É–¥–µ—Ç —Å–º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ –Ω—É–∂–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏. –ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –≤ –æ–±–ª–∞–∫–∞—Ö –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∞–¥–º–∏–Ω—è—Ç—Å—è –≤ –≤–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏–ª–∏ —á–µ—Ä–µ–∑ API? –ù—É –≤–æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –æ–Ω–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∫—É–¥–∞ –ø–æ–π–¥–µ—Ç –ø–∞–∫–µ—Ç, –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç mac –∞–¥—Ä–µ—Å–æ–≤ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü (ip route). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–∞–∫-–Ω–∏–±—É–¥—å –ø–æ–¥–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ç–µ–π –≤ –æ–±–ª–∞–∫–µ (–º–∞—à–∏–Ω–∞ –ê –≤ —Å–µ—Ç–∏ A, —Ä–æ—É—Ç–µ—Ä R –≤ —Å–µ—Ç—è—Ö A –∏ B, –º–∞—à–∏–Ω–∞ B –≤ —Å–µ—Ç–∏ üòé –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ ip route –Ω–∞ –º–∞—à–∏–Ω–∫–∞—Ö. –í–æ—Ç —É–≤–∏–¥–∏—Ç–µ - –Ω–∏—Ñ–∏–≥–∞ –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç üôÇ –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–±–ª–∞–∫–æ –∑–∞ –≤–∞—Å —Ä—É–ª–∏—Ç –ø–∞–∫–µ—Ç–∏–∫–∏ –Ω–µ –æ–±—Ä–∞—â–∞—è –Ω–∞ –≤–∞—à–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∏–∫–∞–∫–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.

–ß—Ç–æ –¥–µ–ª–∞—Ç—å –∏ –∫–∞–∫ –ø–æ—á–∏–Ω–∏—Ç—å keepalvied?

–ù–∞–¥–µ—é—Å—å —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–±–ª–µ–º–∞ —Å—Ç–∞–ª–∞ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–Ω—è—Ç–Ω–µ–µ. –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –µ–µ —Ä–µ—à–∏—Ç—å. –ü–æ—Å–∫–æ–ª—å–∫—É keepalived –º—ã —Å –≤–∞–º–∏ –Ω–µ –ø–µ—Ä–µ–ø–∏—à–µ–º, —Ç–æ –µ—Å—Ç—å –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ. –°—É—Ç—å —Ç–∞–∫–∞—è - –º—ã –∑–∞—Å—Ç–∞–≤–∏–º keepalived –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞—à —Å–∫—Ä–∏–ø—Ç, –∫–æ–≥–¥–∞ –æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–∞—Å—Ç–µ—Ä–æ–º. –¢–æ –µ—Å—Ç—å –≤—Å—è–∫–∏–π —Ä–∞–∑ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –±—É–¥–µ—Ç –¥–µ—Ä–≥–∞—Ç—å—Å—è –Ω–∞—à —Å–∫—Ä–∏–ø—Ç. –í–Ω—É—Ç—Ä–∏ —Å–∫—Ä–∏–ø—Ç–∞ –º—ã –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ—Ç –¥–µ—Ä–≥–∞—Ç—å API –æ–±–ª–∞—á–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, —á—Ç–æ–±—ã –æ–Ω –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏–ª –º–∞—Ä—à—Ä—É—Ç—ã –Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞.

–ö –ø—Ä–∏–º–µ—Ä—É, –≤ —Ö–µ—Ü–Ω–µ—Ä–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç, –æ–ø–∏—Å–∞–Ω–Ω—ã–π –∑–¥–µ—Å—å –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è - https://community.hetzner.com/tutorials/configure-cloud-ha-keepalived. –ò–ª–∏ –≤ digitalocean - https://www.digitalocean.com/community/tutorials/how-to-set-up-highly-available-web-servers-with-keepalived-and-floating-ips-on-ubuntu-14-04.

–í —è–Ω–¥–µ–∫—Å –æ–±–ª–∞–∫–µ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è, –ø–æ—Å–∫–æ–ª—å–∫—É nat-one-to-one –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω. –¢–æ –µ—Å—Ç—å –µ—Å–ª–∏ —É –≤–∞—à–µ–π –º–∞—à–∏–Ω–∫–∏ —É–∂–µ –µ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–π ip, —Ç–æ –≤—Ç–æ—Ä–æ–π –≤—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ –Ω–µ–µ —É–∂–µ –Ω–µ –º–æ–∂–µ—Ç–µ - —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –ø–µ—Ä–µ–µ–∑–∂–∞—Ç—å –±—É–¥–µ—Ç –Ω–µ—á–µ–º—É.

–ù–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –ª—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–µ - —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ - http –∏–ª–∏ network - —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –æ–Ω —Å–∞–º –±—É–¥–µ—Ç —Å–ª–µ–¥–∏—Ç—å –∑–∞ –≤–∞—à–∏–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –∏—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –∏—Ö.


```
#File already had been generated rebrain.pem

# Generate a unique private key (KEY)
sudo openssl genrsa -out rebrain.key 2048

# Generating a Certificate Signing Request (CSR)
sudo openssl req -new -key rebrain.key -out rebrain.csr

# Creating a Self-Signed Certificate (CRT)
openssl x509 -req -days 365 -in rebrain.csr -signkey rebrain.key -out rebrain.crt

# Append KEY and CRT to mydomain.pem
sudo bash -c 'cat rebrain.key rebrain.crt >> /etc/haproxy/rebrain.pem'

```

```
apt install keepalived -y


cat << EOF >> /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv4.ip_nonlocal_bind = 1
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 1
net.ipv4.conf.all.arp_filter = 0
net.ipv4.conf.eth0.arp_filter = 1   #<------correct interface name if needed
EOF
sysctl -p


groupadd -r keepalived_script
useradd -r -s /sbin/nologin -g keepalived_script -M keepalived_script


–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ
–ø—Ä–æ—Å—å–±–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∑–∞–¥–∞–Ω–∏–µ —Ç–∞–∫ –∫–∞–∫ –Ω–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –æ—à–∏–±–∫—É –≤ —Å–≤–æ–µ–º –∫–æ–Ω—Ñ–∏–≥–µ —Ö–æ—Ç—è –≤—Å–µ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∫ –∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è

BACKUP —Å–µ—Ä–≤–µ—Ä –Ω–∞–∑–Ω–∞—á–∏–ª ip –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ haproxy –Ω–∞ MASTER —Å–µ—Ä–≤–µ—Ä–µ: FAILED
BACKUP —É–±—Ä–∞–ª ip –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ haproxy –Ω–∞ MASTER —Å–µ—Ä–≤–µ—Ä–µ: FAILED 


Master node
```
root@rebrain-host-rts:/etc/keepalived# cat ./keepalived.conf
global_defs {
  notification_email {
    marat@mail.ru
    smtp_connect_timeout 30
    enable_traps
  }
}

vrrp_script haproxy {
  script "/usr/bin/killall -0 haproxy"
  interval 2
  weight -50
}

vrrp_instance VRRP1 {
  state MASTER
  interface eth0
  virtual_router_id 69
  advert_int 1
  priority 100
  garp_master_delay 10
  debug 1
  authentication {
    auth_type PASS
    auth_pass 1066
  }

  unicast_src_ip 10.128.0.9
  unicast_peer {
    10.128.0.35
  }

  virtual_ipaddress {
    51.250.10.125/24
  }

  track_script {
    haproxy
  }
}

```

Backup node

```
root@rebrain-host-hcj:/etc/keepalived# cat ./keepalived.conf
global_defs {
  notification_email {
    marat@mail.ru
    smtp_connect_timeout 30
    enable_traps
  }
  user root
}

vrrp_script haproxy {
  script "/usr/bin/killall -0 haproxy"
  interval 2
  weight -50
}

vrrp_instance VRRP1 {
  state BACKUP
  interface eth0
  virtual_router_id 69
  advert_int 1
  priority 75
  garp_master_delay 10
  debug 1
  authentication {
    auth_type PASS
    auth_pass 1066
  }

  unicast_src_ip 10.128.0.35
  unicast_peer {
    10.128.0.9
  }

  virtual_ipaddress {
    51.250.10.125/24
  }

  track_script {
    haproxy
  }
}
```
–û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—á–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –∏–∑-–∑–∞ —á–µ–≥–æ –Ω–µ –ø—Ä–∏–ª–æ–∂–∏–ª –∏—Ö –∫–æ–Ω—Ñ–∏–≥.
```

```
frontend front_cluster
  mode http
  bind *:443 ssl crt /etc/haproxy/rebrain.pem
  http-request set-header X-Forwarded-For %[src]
  default_backend back_cluster

backend back_cluster
  mode http
  balance roundrobin
  server rebrain_01 127.0.0.1:81 check maxconn 20000
  server rebrain_02 127.0.0.1:81 check maxconn 20000
  server rebrain_03 127.0.0.1:81 check maxconn 20000
```

