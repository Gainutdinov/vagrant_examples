Задание:
1. На тестовой VM создайте директорию haproxy и перейдите в нее.
2. Создайте файл docker-compose.yaml со следующим содержимым:
version: '3.5'
services:
backend-server:
image: nginxdemos/hello:0.2
networks:
- internal-net
proxy:
image: haproxy:2.0.14
ports:
- 8080:80
volumes:
- ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
depends_on:
- backend-server
networks:
- internal-net
- external-net
networks:
internal-net :
driver: bridge
internal: true
external-net:
driver: bridge
3. Запустите контейнеры Docker compose, при запуске укажите количество
экземпляров сервиса backend-server равным 2.
4. Создайте файл конфигурации haproxy.cfg HAProxy со следующими параметрами:
● глобальная настройка — количество одновременных подключений 1024;
● значение по умолчанию — режим работы http;
● значение по умолчанию — тайм-аут подключения 3 сек;
● значение по умолчанию — максимальное время просто соединения до клиента 30
сек;
● значение по умолчанию — максимальное время просто соединения до сервера 40
сек;
● имя фронтенда — haproxy_test;
● порт балансировки на фронтенде — 80;
● статистика доступна на фронтенде по URL — /haproxy_stat;
● название бэкенда — nginx_test_page;
● метод балансировки — roundrobin;
● балансировка на 80 порт контейнеров backend-server;
● доступность бэкенда проверяется на уровне L4. Содержимое haproxy.cfg
приложите в ответ к заданию.
5. Откройте в браузере адрес proxy IP:8080. Обновите страницу несколько раз.
Работает ли балансировка? Меняется ли Server address и Server name?
6. Установите пакет apache2-utils, если он не установлен. Запустите тест ab:
○ время выполнения теста — 20 сек;
○ число конкурентных потоков — 50;
○ URL — обращения на контейнер haproxy_proxy по порту 8080. Ознакомьтесь
с результатами тестирования. Есть ли отличия в скорости работы по
сравнению с балансировкой через nginx?
7. Откройте статистику haproxy в браузере. Ознакомьтесь с доступной информацией.
8. Повторите тестирование из предыдущего п. 6, но во время выполнения теста
перезапустите один из контейнеров backend-server. Была ли потеря трафика при
рестарте контейнера при текущей конфигурации?
