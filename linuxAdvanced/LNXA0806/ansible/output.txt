Здравствуйте.



curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

docker run -it --rm \
	--name  ipa.simpledevops.xyz \
	--hostname ipa.simpledevops.xyz \
	--volume /opt/freeipa-data/:/data \
	--publish "443:443" \
	--publish "80:80" \
	--publish "389:389" \
	--publish "636:636" \
	--publish "88:88" \
	--publish "88:88/udp" \
	--publish "464:464" \
	--publish "464:464/udp" \
	-v /sys/fs/cgroup:/sys/fs/cgroup:ro \
	--tmpfs /run \
	--tmpfs /tmp \
	--security-opt seccomp=unconfined \
	--sysctl net.ipv6.conf.all.disable_ipv6=0 \
	freeipa/freeipa-server:rocky-8-4.9.6





proxy_cache_path cache/ keys_zone=kibana_auth_cache:10m;
upstream backend_kibana_1 {
    server 127.0.0.1:5601;
}
server {
    listen 443 ssl;
    server_name kibana.example.com;
       ssl_certificate /etc/ssl/certs/example.crt ;
       ssl_certificate_key /etc/ssl/certs/example.key;
## PCI-DSS Compliance
    include  /etc/nginx/include/pci-dss.conf;
## PCI-DSS Compliance
###### enable autorization
    auth_basic "Restricted Access. Use LDAP";
# log project
    access_log  /var/log/nginx/kibana.example.com-access.log  advanced;
    error_log   /var/log/nginx/kibana.example.com-error.log;
       location / {
                auth_request    /auth-ldap;
                proxy_pass_header Server;
                proxy_set_header Host $http_host;
                proxy_redirect off;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Scheme $scheme;
                proxy_pass http://backend_kibana_1;
    }
        # enable autorization LDAP
        location        =       /auth-ldap      {
                internal;
                proxy_pass      http://127.0.0.1:8888;
                proxy_pass_request_body off;
                proxy_set_header        Content-Length  "";
                proxy_cache     kibana_auth_cache;
                proxy_cache_valid       200     1m;
                proxy_cache_key "$http_authorization$cookie_nginxauth";
                proxy_set_header        X-Ldap-URL      "ldaps://ipaserver.domain.example.com:636";
                proxy_set_header        X-Ldap-Starttls "false";
                proxy_set_header        X-Ldap-BaseDN   "cn=users,cn=accounts,dc=domain,dc=example,dc=ru";
                proxy_set_header        X-Ldap-BindDN   "uid=s-asamon-01,cn=sysaccounts,cn=etc,dc=domain,dc=example,dc=ru";
                proxy_set_header        X-Ldap-BindPass "our-password";
                proxy_set_header        X-CookieName    "nginxauth";
                proxy_set_header        Cookie  nginxauth=$cookie_nginxauth;
                proxy_set_header        X-Ldap-Template "(&(objectclass=person)(uid=%(username)s)(memberOf=cn=kibana-admins,cn=groups,cn=accounts,dc=domain,dc=example,dc=ru))";
        }
}



----------------------------------------------------------------------------------------------------------------------------------------------------------------

        location = /auth-proxy {
            proxy_pass http://127.0.0.1:8888;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_cache auth_cache; # Must match the name in the proxy_cache_path directive above
            proxy_cache_valid 200 1m;
            proxy_cache_key "$http_authorization$cookie_nginxauth";
            # URL and port for connecting to the LDAP server
            proxy_set_header X-Ldap-URL "ldap://127.0.0.1:389";
#            proxy_set_header X-Ldap-URL "ldaps://ipa.simpledevops.xyz:636";
            proxy_set_header X-Ldap-Starttls "false";
            proxy_set_header X-Ldap-BaseDN   "cn=users,cn=compat,dc=simpledevops,dc=xyz";
#                                uid=siteadmin,cn=users,cn=compat,dc=simpledevops,dc=xyz
            proxy_set_header X-Ldap-BindDN   "uid=admin,cn=users,cn=compat,dc=simpledevops,dc=xyz";
            proxy_set_header X-Ldap-BindPass "password";
            proxy_set_header X-CookieName    "nginxauth";
            proxy_set_header X-Ldap-Template "(&(objectclass=person)(uid=%(username)s)(memberOf=cn=webadmins,cn=groups,cn=compat,dc=simpledevops,dc=xyz))";
            # Negotiate a TLS-enabled (STARTTLS) connection before sending credentials
            # Base DN
#            proxy_set_header X-Ldap-Template "(uid=%(username)s)";
#            proxy_set_header X-Ldap-BindDN "uid=%(username)s,cn=groups,cn=groups,dc=simpledevops,dc=xyz";
#cn=siteadmin,cn=groups,cn=accounts,dc=simpledevops,dc=xyz
#            proxy_set_header X-Ldap-BindDN "(&(objectClass=person)(uid=%(username)s)(memberof=cn=webadmins,cn=groups,cn=accounts,dc=simpledevops,dc=xyz))";
            # Bind DN
#            proxy_set_header X-Ldap-BindDN "cn=admin,cn=users,cn=accounts,dc=ipa,dc=simpledevops,dc=xyz";
#            uid=admin,cn=users,cn=accounts,dc=simpledevops,dc=xyz
#            proxy_set_header X-Ldap-BindPass "secret";
#            proxy_set_header X-Ldap-BaseDN "dc=simpledevops,dc=xyz";
#            proxy_set_header X-Ldap-Template "(memberof=cn=webadmins,cn=groups,cn=accounts,dc=simpledevops,dc=xyz)";
#            proxy_set_header X-Ldap-Template "(&(objectCategory=person)(sAMAccountName=%(username)s)(|(memberOf=cn=webadmins,cn=groups,cn=accounts,dc=simpledevops,dc=xyz))";
#            proxy_set_header X-Ldap-Template "(&(objectCategory=person)(uid=%(username)s)(|(memberOf=cn=webadmins,cn=groups,cn=accounts,dc=simpledevops,dc=xyz))";
            # Bind password
        }


